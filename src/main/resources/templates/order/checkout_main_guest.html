<!DOCTYPE html>
<html lang="en"
      layout:decorate="~{layouts/layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<meta charset="UTF-8">

<th:block layout:fragment="css">
    <link rel="stylesheet" th:href="@{/static/assets/css/checkout.css}"/>
    <script src="https://js.tosspayments.com/v1"></script>
</th:block>

<div layout:fragment="content">
    <div class="container py-3">
        <main id="main">
            <h3>비회원 주문/결제</h3>
            <div class="row g-5">
                <div class="col-md-12 col-lg-12">
                    <h4 class="mb-3">구매자 정보</h4>
                    <form class="needs-validation" id="payment-form" novalidate>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label" for="buyer_name">이름</label>
                                <input class="form-control" id="buyer_name" name="buyerName" placeholder="" required=""
                                       type="text"
                                       value="테스트">
                                <div class="invalid-feedback">
                                    필수 입력 값입니다.
                                </div>
                            </div>

                            <div class="col-12">
                                <label class="form-label" for="buyer_phone">전화번호</label>
                                <input class="form-control" id="buyer_phone" name="buyerPhone"
                                       placeholder="휴대폰 번호를 ‘-’없이 입력해주세요"
                                       required="" type="text"
                                       value="01011112222">
                                <div class="invalid-feedback">
                                    필수 입력 값입니다.
                                </div>
                            </div>

                            <div class="col-12">
                                <label class="form-label" for="buyer_email">Email</label>
                                <div class="input-group has-validation">
                                    <span class="input-group-text">@</span>
                                    <input class="form-control" id="buyer_email" name="buyerEmail"
                                           placeholder="you@example.com"
                                           type="email" value="d@d.com">
                                    <div class="invalid-feedback">
                                        필수 입력 값입니다.
                                    </div>
                                </div>
                            </div>

                            <div class="col-12">
                                <label class="form-label" for="buyer_password">주문 조회 비밀번호 입력</label>
                                <input class="form-control" id="buyer_password" name="buyerPassword" placeholder=""
                                       required=""
                                       type="password"
                                       value="1234">
                                <div class="invalid-feedback">
                                    필수 입력 값입니다.
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <h4 class="mb-3">받는 사람 정보</h4>

                        <div class="col-12">
                            <button class="btn btn-primary" id="sameAsBuyer" type="button">구매자와 동일</button>
                        </div>

                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label" for="recipient_name">이름</label>
                                <input class="form-control" id="recipient_name" name="recipientName" placeholder=""
                                       required="" type="text" value="테스트">
                                <div class="invalid-feedback">
                                    필수 입력 값입니다.
                                </div>
                            </div>

                            <div class="col-12">
                                <label class="form-label" for="recipient_phone">전화번호</label>
                                <input class="form-control" id="recipient_phone" name="recipientPhone"
                                       placeholder="휴대폰 번호를 ‘-’없이 입력해주세요"
                                       required="" type="text" value="01011112222">
                                <div class="invalid-feedback">
                                    필수 입력 값입니다.
                                </div>
                            </div>

                            <input class="btn btn-primary" onclick="recipient_execDaumPostcode()" type="button"
                                   value="우편번호 찾기"><br>

                            <div class="col-9">
                                <label class="form-label" for="recipient_address">주소</label>
                                <input class="form-control" id="recipient_address" name="recipientAddress"
                                       onclick="recipient_execDaumPostcode()" placeholder="" required="" type="text"
                                       value="주소">
                                <div class="invalid-feedback">
                                    필수 입력 값입니다.
                                </div>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label" for="recipient_postcode">우편번호</label>
                                <input class="form-control" id="recipient_postcode" name="recipientPostcode"
                                       onclick="recipient_execDaumPostcode()" placeholder="" required="" type="text"
                                       value="12345">
                                <div class="invalid-feedback">
                                    필수 입력 값입니다.
                                </div>
                            </div>

                            <div class="col-12">
                                <label class="form-label" for="recipient_detailAddress">상세주소<span
                                        class="text-body-secondary">(Optional)</span></label>
                                <input class="form-control" id="recipient_detailAddress" name="recipientDetailAddress"
                                       placeholder="" type="text">
                            </div>
                        </div>

                        <hr class="my-4">

                        <h4>배송일 선택</h4>

                        <p class="text-muted">도착 예상일</p>
                        <div>
                            <input autocomplete="off" checked class="btn-check" id="option1" name="options"
                                   type="radio">
                            <label class="btn btn-outline-primary" for="option1"
                                   th:text="${#temporals.format(#temporals.createNow().plusDays(1), '내일 (M/d)')}">Checked</label>

                            <input autocomplete="off" class="btn-check" id="option2" name="options" type="radio">
                            <label class="btn btn-outline-primary" for="option2"
                                   th:text="${#temporals.format(#temporals.createNow().plusDays(2), 'E (M/d)')}">Radio</label>

                            <input autocomplete="off" class="btn-check" id="option3" name="options"
                                   type="radio">
                            <label class="btn btn-outline-primary" for="option3"
                                   th:text="${#temporals.format(#temporals.createNow().plusDays(3), 'E (M/d)')}">Radio</label>

                            <input autocomplete="off" class="btn-check" id="option4" name="options" type="radio">
                            <label class="btn btn-outline-primary" for="option4"
                                   th:text="${#temporals.format(#temporals.createNow().plusDays(4), 'E (M/d)')}">Radio</label>

                            <input autocomplete="off" class="btn-check" id="option5" name="options" type="radio">
                            <label class="btn btn-outline-primary" for="option5"
                                   th:text="${#temporals.format(#temporals.createNow().plusDays(5), 'E (M/d)')}">Radio</label>

                            <input autocomplete="off" class="btn-check" id="option6" name="options" type="radio">
                            <label class="btn btn-outline-primary" for="option6"
                                   th:text="${#temporals.format(#temporals.createNow().plusDays(6), 'E (M/d)')}">Radio</label>
                        </div>

                        <hr class="my-4">

                        <h4 class="mb-3">주문 상품</h4>

                        <div class="row d-flex align-items-center" th:each="orderBook, status: ${orderBookList}">
                            <div class="col-md-2">
                                <img alt="Book Thumbnail" class="img-thumbnail"
                                     th:src="${orderBook.bookThumbnailUrl}">
                            </div>
                            <div class="col-md">
                                <p th:text="${orderBook.bookTitle}"/>
                            </div>
                            <div class="col-md-1">
                                <p th:text="${orderBook.quantity}"/>
                            </div>
                            <div class="col-md-2">
                                <p th:text="${orderBook.bookSalePrice}"/>
                            </div>
                        </div>

                        <hr class="my-4">

                        <h4 class="mb-3">결제 정보</h4>

                        <div class="row mb-3">
                            <div class="col-6">
                                <p>총 상품 가격</p>
                            </div>
                            <div class="col-6 text-end">
                                <p id="totalProductPrice" th:text="${totalProductPrice} + 원">/p>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <p>배송비</p>
                            </div>
                            <div class="col-6 text-end">
                                <p id="shippingFee">5000원</p>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <p>쿠폰</p>
                            </div>
                            <div class="col-6 text-end">
                                <p id="coupon">회원만 사용 가능합니다.</p>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <p>포인트</p>
                            </div>
                            <div class="col-6 text-end">
                                <p id="point">회원만 사용 가능합니다.</p>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <p>총 결제 금액</p>
                            </div>
                            <div class="col-6 text-end">
                                <p id="totalPayment" th:text="${totalProductPrice} - 5000 + 원">0원</p>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <!-- 결제 UI -->
                                <div id="payment-method"></div>
                                <!-- 이용약관 UI -->
                                <div id="agreement"></div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <button class="w-100 btn btn-primary btn-lg" id="payment-button" type="submit">결제하기</button>
                    </form>
                </div>
            </div>

            <!-- iOS에서는 position:fixed 버그가 있음, 적용하는 사이트에 맞게 position:absolute 등을 이용하여 top,left값 조정 필요 -->
            <div id="layer"
                 style="display:none;position:fixed;overflow:hidden;z-index:1;-webkit-overflow-scrolling:touch;">
                <img alt="닫기 버튼" id="btnCloseLayer"
                     onclick="pay('카드',jsons.card);"
                     src="//t1.daumcdn.net/postcode/resource/images/close.png"
                     style="cursor:pointer;position:absolute;right:-3px;top:-3px;z-index:1">
            </div>
        </main>
    </div>
</div>


<th:block layout:fragment="script">
    <script src="/static/assets/js/checkout.js" type="text/javascript"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="/static/assets/js/order_main_address.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        window.onload = function () {
            let totalProductPrice = document.getElementById('totalProductPrice').innerText;
            let shippingFee = document.getElementById('shippingFee').innerText;

            // 숫자만 추출
            totalProductPrice = parseInt(totalProductPrice.replace(/[^0-9]/g, ''));
            shippingFee = parseInt(shippingFee.replace(/[^0-9]/g, ''));

            let totalPayment = totalProductPrice - shippingFee;

            document.getElementById('totalPayment').innerText = totalPayment + '원';
        }

        let amount = /*[[${totalProductPrice} - 5000]]*/ 500;

        let tossPayments = TossPayments("test_ck_ALnQvDd2VJdOYqKbPLYv8Mj7X41m");

        function getCustomerInfo() {
            let buyerName = document.getElementById('buyer_name').value;
            let buyerEmail = document.getElementById('buyer_email').value;
            let buyerPhone = document.getElementById('buyer_phone').value;

            return {
                name: buyerName,
                email: buyerEmail,
                phone: buyerPhone
            };
        }

        function pay(method, requestJson) {
            let customerInfo = getCustomerInfo();

            requestJson.customerName = customerInfo.name;
            requestJson.customerEmail = customerInfo.email;
            requestJson.customerMobilePhone = customerInfo.phone;

            console.log(requestJson);
            tossPayments.requestPayment(method, requestJson).catch(function (error) {
                if (error.code === "USER_CANCEL") {
                    alert("유저가 취소했습니다.");
                } else {
                    alert(error.message);
                }
            });
        }

        let path = "/";
        let successUrl = window.location.origin + path + "success";
        let failUrl = window.location.origin + path + "fail";
        let orderId = new Date().getTime();

        let jsons = {
            card: {
                amount: amount,
                orderId: /*[[${orderId}]]*/ "sample-" + orderId,
                orderName: /*[[${orderName}]]*/ "책 주문",
                successUrl: successUrl,
                failUrl: failUrl,
                cardCompany: null,
                cardInstallmentPlan: null,
                maxCardInstallmentPlan: null,
                useCardPoint: false,
                customerName: "박토스",
                customerEmail: null,
                customerMobilePhone: null,
                taxFreeAmount: null,
                useInternationalCardOnly: false,
                flowMode: "DEFAULT",
                discountCode: null,
                appScheme: null,
            },
        };

        document.getElementById('payment-form').addEventListener('submit', function (event) {
            event.preventDefault();
            if (this.checkValidity()) {
                pay('카드', jsons.card);
            } else {
                event.stopPropagation();
            }
        }, false);
        /*]]>*/
    </script>
</th:block>

</html>